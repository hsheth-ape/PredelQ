# Session Log: 2025-12-31-planning-003

> **Type:** Planning + Execution (EWS Dashboard)
> **Date:** 2025-12-31
> **Duration:** ~45 min
> **Status:** Complete

---

## Session Goal

Build database schema and views to support the Early Warning Signals (EWS) dashboard matching the Figma mockup.

---

## What Was Built

### New Table: `event_types`

| ID | Code | Name | Customer-Facing | Display Order |
|----|------|------|-----------------|---------------|
| 1 | observability | Observability | Yes | 6 |
| 2 | ingestion | Ingestion | No | 7 |
| 3 | transactional | Transactional | Yes | 2 |
| 4 | operational | Operational | Yes | 3 |
| 5 | behavioural | Behavioural | Yes | 4 |
| 6 | environmental | Environmental | Yes | 5 |
| 7 | reserved | Reserved | No | 99 |
| 8 | identity | Identity | Yes | 1 |

### Schema Changes

- Added `event_type_id` FK to `event_definitions`
- Migrated existing `category` values to new `event_type_id`
- Added `risk_score` (1-5) and `risk_category` to `customer_current_state`
- Created `get_risk_category()` function

### New Views

| View | Purpose | Matches Mockup |
|------|---------|----------------|
| `v_ews_risk_summary` | Summary cards (High/Med/Low counts) | ✓ |
| `v_ews_customer_events` | Detail table (customer → event type → event) | ✓ |
| `v_ews_customer_summary` | Pivot view (event counts by type per customer) | ✓ |

### Risk Score Logic

| Score | Category | Criteria |
|-------|----------|----------|
| 5 | Very High | Open events with severity >= 4 |
| 4 | High | Delinquent account or DPD > 30 |
| 3 | Medium | DPD > 0 or severity 3 events |
| 2 | Low | Any open events |
| 1 | Very Low | Clean (no events, no DPD) |

---

## Current Data State

```
Risk Summary:
- Very High: 1 customer (Suresh Reddy)
- High: 2 customers
- Medium: 2 customers  
- Very Low: 10 customers

Sample Events:
[Very High] Suresh Reddy | Identity, Transactional, Operational | 3 events
[High] Fatima Begum | Transactional | 1 event
[Medium] Lakshmi Nair | Identity, Transactional, Operational | 3 events
```

---

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Event type taxonomy | 8 types (5 customer-facing) | Matches framework doc and mockup |
| Risk score | 1-5 scale at customer level | Aligns with indicator framework |
| Event-to-customer join | CTE handling both asset and account events | Events can be on either entity |
| Category migration | payment/delinquency → transactional, location → identity, utilization → operational | Best fit mapping |

---

## Input Documents Used

- Figma mockup (EWS dashboard)
- `dim_event_category.csv` (402 event definitions)
- `Framework__EVOK.pdf` (event type taxonomy)

---

## Next Steps

1. **Build Metabase dashboard** using the 3 views
2. **Import full event catalog** (402 events from CSV) - pending discussion
3. **Add 30-day delta** for summary cards (optional)

---

## Metabase Query Guide

### Summary Cards
```sql
SELECT risk_category, customer_count 
FROM v_ews_risk_summary 
WHERE risk_score >= 4;  -- High + Very High
```

### Main Table
```sql
SELECT * FROM v_ews_customer_events;
-- Group by customer_name, then event_type in Metabase
```

### Pivot View
```sql
SELECT * FROM v_ews_customer_summary;
```

---

## Promote to Project Docs

| Item | Target | Done |
|------|--------|------|
| event_types table | SCHEMA.md | Pending |
| EWS views | METABASE_GUIDE.md | Pending |
| Risk score logic | CURRENT.md | Pending |
